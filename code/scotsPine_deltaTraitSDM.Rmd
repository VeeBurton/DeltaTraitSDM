---
title: "Applying the Î”TraitSDM to a multi-site provenance trial of native Scots pine (_Pinus sylvestris_)"
output: 
  prettydoc::html_pretty:
    theme: architect
    
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
# load libraries
library(tidyverse)
library(ggplot2)
library(lme4)
library(nlme)
library(MuMIn)
library(raster)
library(rgdal)
library(rworldmap)
library(sjPlot) 
library(corrplot)
library(caret)
library(performance)
library(kableExtra)
library(sf)
library(raster)
library(foreign)
library(tmap)

wd<-"C:/Users/vanessa.burton/OneDrive - Forest Research/Documents/R/DeltaTraitSDM/"

```

## Most important variables highlighted by analysis so far

A number of strategies have been applied to explore the data and try to uncover the climate variables which may be explanatory for height.

According to pairplots:

  - MWMT_T
  - PAS_T 
  - TD_T
  - DD0_T 
  - MCMT_T
  - eFFP_T
  - Eref_T
  - EMT_T 
  - DD_18_T
  - NFFD_T
  
According to PCA:

  - DD_18_T
  - FFP_T
  - bFFP_P
  - FFP_P
  - TD_P
  
According to exploration/difference between trial & provenance:

  - PAS
  - TD
  - MWMT
  - DD0
  - MCMT
  
So more generally, the factors driving height may be: *snow cover*, *temperature extremes* (warmest and coldest month temperatures, degree days below 0), *frost free period* and when this begins/ends, and temperature difference between coldest and warmest temperatures (*continentality*).
  
```{r data, include=FALSE}

# read in standardised data (with raw height)
sp.raw <- read.csv(paste0(wd,"Scots_pine/Scots_pine_H.csv")) # raw data
sp.raw$X <- NULL
str(sp.raw)
sp.raw<-na.omit(sp.raw)
sp <- read.csv(paste0(wd,"Scots_pine/Scots_pine_H_cent_scal_allvars.csv")) # 
sp$X <- NULL
str(sp)
colnames(sp)[1]<-"Hscal"
sp$Hraw <- sp.raw$W17Height
sp$Trial <- sp.raw$Trial
sp$Provenance <- sp.raw$Provenance
sp$Block <- sp.raw$Block
colnames(sp)[22]<-'EMT_P'
colnames(sp)[41]<-'EMT_T'
rm(sp.raw)

```

The data is nested Trial/Block/Provenance. Figure \@ref(fig:boxplot) illustrates that there is variation in height between trials, and also within trials according to provenance. So there is value in fitting a mixed-effects model to explore height, with the random effects structure taking account of the different trials and provenances.

```{r boxplot, include=TRUE, echo=FALSE}
# double check nesting
sp %>% 
  ggplot(aes(Trial:Block:Provenance,Hraw, colour=Trial))+geom_boxplot()+
  theme_minimal()+
  ylab("Height (mm)")+
  theme(axis.text.x = element_blank()) #element_text(size=6,angle = 90, hjust = 1))
```

## Initial models to try

A number of models combining the 'important' variables have been produced (see code chunk below).

## Compare model performance

```{r model-performance, include=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(message = FALSE)
# initial models
pair.mod1 <- lmer(Hraw ~ MWMT_T + PAS_P + MWMT_T*PAS_P + (1|Trial/Block/Provenance), data=sp)
pair.mod2 <- lmer(log(Hraw) ~ MWMT_P + PAS_T + MWMT_P*PAS_T + (1|Trial/Block/Provenance), data=sp)
pair.mod3 <- lmer(log(Hraw) ~ TD_P + Eref_T + TD_P*Eref_T + (1|Trial/Block/Provenance), data=sp)
pca.mod1 <- lmer(log(Hraw) ~ DD_18_T + FFP_P + DD_18_T*FFP_P + (1|Trial/Block/Provenance), data=sp)
pca.mod2 <- lmer(log(Hraw) ~ DD_18_T + TD_P + DD_18_T*TD_P + (1|Trial/Block/Provenance), data=sp)
pca.mod3 <- lmer(log(Hraw) ~ FFP_T + TD_P + FFP_T*TD_P + (1|Trial/Block/Provenance), data=sp)
diff.mod1 <- lmer(log(Hraw) ~ PAS_P + TD_T + PAS_P*TD_T + (1|Trial/Block/Provenance), data=sp)
diff.mod2 <- lmer(log(Hraw) ~ MWMT_P + MCMT_T + MWMT_P*MCMT_T + (1|Trial/Block/Provenance), data=sp)
diff.mod3 <- lmer(log(Hraw) ~ DD0_P + PAS_T + DD0_P*PAS_T + (1|Trial/Block/Provenance), data=sp)
init.compare <- compare_performance(pair.mod1,pair.mod2,pair.mod3,pca.mod1,pca.mod2,pca.mod3,diff.mod1,diff.mod2,diff.mod3, rank = TRUE)
knitr::kable(head(init.compare[,1:8],10), booktabs=TRUE,
             caption = "Comparison of initial model indices") %>% 
  kableExtra::kable_styling(latex_options = c("hold_position"), font_size = 9)
#r2(diff.mod3)$R2_marginal
#icc(diff.mod3)
#check_model(diff.mod3)

# "best models" from dredge
dredge1<-lmer(log(Hraw) ~ DD_18_T + NFFD_P + DD_18_T*NFFD_P + (1|Trial/Block/Provenance),data = sp)
dredge2<-lmer(log(Hraw) ~ DD_18_T + NFFD_P + PAS_T + DD_18_T*NFFD_P + NFFD_P*PAS_T (1|Trial/Block/Provenance),data = sp)
dredge3<-lmer(log(Hraw) ~ DD_18_T + NFFD_P + TD_T + DD_18_T*NFFD_P + NFFD_P*TD_T+ (1|Trial/Block/Provenance),data = sp)
dredge.compare <- compare_performance(diff.mod3,pair.mod3,pair.mod2,dredge1,dredge2,dredge3, rank = TRUE)
knitr::kable(head(dredge.compare[,1:8],6), booktabs=TRUE,
             caption = "Comparison of dredge model indices") %>% 
  kableExtra::kable_styling(latex_options = c("hold_position"), font_size = 9)

# from richard's thesis
whittet.mod1 <- lmer(log(Hraw) ~ MAP_T + FFP_P + MAP_T*FFP_P + (1|Trial/Block/Provenance), data = sp)
whittet.mod2 <- lmer(log(Hraw) ~ MAP_P + FFP_T + MAP_P*FFP_T + (1|Trial/Block/Provenance), data = sp)
whittet.mod3 <- lmer(log(Hraw) ~ DD5_T + MWMT_P + MCMT_T + MAP_T + TD_P + DD5_T*MWMT_P + (1|Trial/Block/Provenance), data = sp)


compare.best <- compare_performance(dredge1,diff.mod3,dmod3.int,pair.mod3,pair.mod2,whittet.mod1,whittet.mod2,whittet.mod3, rank=TRUE)
knitr::kable(head(compare.best[,1:9],9), booktabs=TRUE,
             caption = "Comparison of 'best' model indices") %>% 
  kableExtra::kable_styling(latex_options = c("hold_position"), font_size = 9)

plot(compare.best)
#write.csv(compare.best, paste0(wd,'/Scots_pine/compare_performance.csv'))

```

## Cross-validation

Using the five 'best' models from the comparisons above, cross-validation was carried out.

```{r cross-validation, include=FALSE}
# run on training and test datasets
#results<-NULL

#for(i in 1:1000) {
  
  #i<-1
  #rows<-sample(x=1:nrow(sp),size=round(nrow(sp)*0.25,1))
  #training<-sp[-rows,]
  #testing<-sp[rows,]
  
  #dredge1<-lmer(log(Hraw) ~ DD_18_T + NFFD_T + (1|Trial/Block/Provenance),data = training)
  #pair.mod3 <- lmer(log(Hraw) ~ TD_T + Eref_T + (1|Trial/Block/Provenance), data=training)
  #diff.mod3 <- lmer(log(Hraw) ~ DD0_P + PAS_T + (1|Trial/Block/Provenance), data=training)
  #pair.mod2 <- lmer(log(Hraw) ~ MWMT_T + PAS_T + (1|Trial/Block/Provenance), data=training)
  #whittet.mod2 <- lmer(log(Hraw) ~ MAP_P + FFP_T  + (1|Trial/Block/Provenance), data = training)
  
  #p.dr1<-predict(dredge1,testing)-log(testing$Hraw)
  #p.pr3<-predict(pair.mod2,testing)-log(testing$Hraw)
  #p.df3<-predict(diff.mod3,testing)-log(testing$Hraw)
  #p.pr2<-predict(pair.mod2,testing)-log(testing$Hraw)
  #p.wh2<-predict(whittet.mod2,testing)-log(testing$Hraw)
  
  #results<-rbind(results,data.frame(Run=rep(i,5),Model=c('dredge1','pair.mod3','diff.mod3','pair.mod2','whittet.mod2'),
   #                                 MAE=c(mean(abs(p.dr1)),mean(abs(p.pr3)),mean(abs(p.df3)),mean(abs(p.pr2)),mean(abs(p.wh2))),
  #                                  R2marg=c(r2(dredge1)$R2_marginal, r2(pair.mod3)$R2_marginal, r2(diff.mod3)$R2_marginal,
  #                                           r2(pair.mod2)$R2_marginal,r2(whittet.mod2)$R2_marginal)))
  
#}

#write.csv(results, paste0(wd,'Scots_pine/cross-validation_results.csv'))

```

The results of the cross validation indicate that...

```{r cv-results, include=T, echo=FALSE}
results<-read.csv(paste0(wd,'Scots_pine/cross-validation_results.csv'))
summary(results)
hist(results$MAE,breaks=50)
hist(results$R2marg,breaks=50)

results %>% 
  ggplot(aes(Model,MAE, colour=Model))+geom_boxplot()+
  theme_minimal()+
  ylab("MAE")+
  theme(axis.text.x = element_blank())

results %>% 
  ggplot(aes(Model,R2marg, colour=Model))+geom_boxplot()+
  theme_minimal()+
  ylab("R2marg")+
  theme(axis.text.x = element_blank())

resAVE<-aggregate(MAE~Model,results,FUN=mean)
resAVE<-resAVE[order(resAVE[,2],decreasing=F),]

```

## DeltaTraitSDM

```{r climate-surfaces, include=TRUE, echo=FALSE}

library(foreign)
dem <- raster(paste0(wd,'/climate_surfaces/UKdem1k.tif'))
# convert to dataframe x,y,elev
demDF <- as.data.frame(dem,xy=TRUE)
head(demDF)
colnames(demDF) <- c('x','y','elev')
# export for Arc to get coordinates
write.csv(demDF, paste0(wd,"climate_surfaces/UKdem1k_df.csv"), row.names = FALSE, quote = FALSE)
# read back in reprojected data (WGS84) with lat long (data management::features::get xy coordinates)
coords <- read.dbf(paste0(wd,"climate_surfaces/dem1k_reproj.dbf"))
head(coords)
summary(coords)
coords$elev<-as.numeric(as.character(coords$elev))
summary(coords)
coords<-na.omit(coords)
#coords<-filter(coords, elev!=1080)
# correct format
coords <- coords[,c(1,2,5,4,3)]
colnames(coords) <- c("id1","id2","lat","long","elev")
head(coords)
histogram(coords$elev)
#check
ggplot(coords)+
  geom_point(aes(long,lat,col=elev))

# export for climateEU
#write.csv(coords, paste0(wd,"climate_surfaces/for-climateEU.csv"))

# read in climate data
climate <- read.csv(paste0(wd,"climate_surfaces/for-climateEU_Normal_1961_1990Y.csv"))
#head(climate)
colnames(climate)<-c('x','y','lat','long','elev','MAT','MWMT','MCMT','TD','MAP','MSP','AHM','SHM','DD0','DD5','DD_18','DD18','NFFD','bFFP','eFFP','FFP','PAS','EMT','Eref','CMD')
climate[climate=="-9999"]<-NA
climate <- na.omit(climate)
summary(climate)
#ggplot(climate)+geom_point(aes(x,y))
library(raster)
coordinates(climate) <- ~ x + y
gridded(climate) <- TRUE
#summary(climate)
DD_18 <- raster(climate,layer='DD_18')
plot(DD_18,main="DD < 18")
summary(climate$DD_18)
NFFD <- raster(climate,layer='NFFD')
plot(NFFD, main="NFFD")
MAP <- raster(climate,layer='MAP')
plot(MAP,main="MAP")
FFP <- raster(climate,layer='FFP')
plot(FFP,main="FFP")
TD <- raster(climate,layer='TD')
plot(TD,main="TD")
Eref <- raster(climate, layer='Eref')
plot(Eref,main="Eref")
DD0 <- raster(climate,layer="DD0")
plot(DD0,main="DD0")
PAS <- raster(climate,layer="PAS")
plot(PAS,main="PAS")
```


```{r DTSDM, include=TRUE, echo=FALSE}

# current distribution of scots pine
#PinusDistr <- shapefile("file:///C:/Users/vanessa.burton/OneDrive - Forest Research/Documents/R/DeltaTraitSDM/Scots_pine/Pinus_sylvestris/Pinus_sylvestris_EUFORGEN.shp") 
# load Europe
#library("rworldmap")
#worldmap <- getMap(resolution = "high")
#summary(worldmap)
#unique(worldmap$SOVEREIGNT)
#unique(worldmap$GEO3)
#UK <- worldmap[which(worldmap$SOVEREIGNT=="United Kingdom" & worldmap$GEO3=="Western Europe" & worldmap$LAT>50),] 
UK <- shapefile(paste0(wd,"Scots_pine/european_region_region.shp"))
plot(UK)
crs(UK) 

# raster stack of climate variables
ST_H <- DD_18
mean(sp$Hraw) #  stand age?
values(ST_H) <- 126 # assign mean height to raster of same extent?
plot(ST_H)
rsmax <- stack(ST_H, DD0, PAS) #stack(ST_H, MAP, FFP) #stack(ST_H, DD_18, NFFD)
names(rsmax)= c("Hraw","DD0_P","PAS_T")#c("Hraw","DD_18_T","NFFD_T")
names(rsmax)
plot(rsmax)

#predict height
predH <- predict(rsmax, diff.mod3, re.form=NA, type='response') #whittet.mod2 #dredge1
predH<- log(predH)
plot(predH, main="Tree height predicted")

crs(predH)<- "+init=epsg:27700" # british national grid

tm_shape(predH) +
  tm_style("beaver")+
  tm_raster(palette="PuBuGn",style = 'pretty', title = "Tree height predicted") +
  tm_legend(outside = TRUE)+
  tm_shape(UK)+
  tm_borders(lwd=1)

# mask with current distribution
#### Mask
nwss <- shapefile(paste0(wd,"Scots_pine/FCPRODUCT_S_NWSS.shp")) 
summary(nwss)
nwss<-st_as_sf(nwss)
#unique(nwss$DOM_HABITA)
nativePine<-nwss%>%filter(DOM_HABITA=="Native pinewood")
#plot(st_geometry(nativePine))
predDist<- mask(predH, nativePine)
#plot(predDist, main="Tree height prediction within current Scots pine distribution")
#crs(predDist) 
#plot(UK,add=TRUE)

tm_shape(predDist) +
  tm_style("beaver")+
  tm_raster(palette="PuBuGn",style = 'pretty', title = "Tree height predicted within current distribution") +
  tm_legend(outside = TRUE)+
  tm_shape(UK)+
  tm_borders(lwd=1)

```

