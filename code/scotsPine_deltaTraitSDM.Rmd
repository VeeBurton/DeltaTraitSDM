---
title: "Applying the ΔTraitSDM to a multi-site provenance trial of native Scots pine (_Pinus sylvestris_)"
output: bookdown::html_document2 
    
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
# load libraries
library(tidyverse)
library(ggplot2)
library(lme4)
library(nlme)
library(rgdal)
library(corrplot)
library(caret)
library(performance)
library(stargazer)
library(kableExtra)
library(sf)
library(sp) # for polygons
library(raster) # for rasters
library(tmap) # for plotting
library(viridis) # for palette
library(classInt) # control raster bins

#extrafont::font_import() # make sure fonts loaded

wd<-"~/Documents/FR/FR_R/DeltaTraitSDM/" # mac wd

```

This file documents the process of finding the most important climate variables which may be influencing native Scots pine height across Scotland.
It shows the testing of a number of mixed-effects models, their comparison, and their implementation within a ΔTraitSDM framework to predict current and future distribution of the trait of interest.

# Climate variables driving height

A number of strategies have been applied to explore the data and try to uncover the climate variables which may be explanatory for height.

According to pairplots, the variables with greatest correlation with height included: MWMT_T, PAS_T, TD_T, DD0_T, MCMT_T, eFFP_T (Figure \@ref(fig:pairplots)).

```{r pairplots, include=T, echo=F, fig.cap="Pairplots",out.width="100%"}

knitr::include_graphics(paste0(wd,'figures/sp_pairplots.png'))

```

  
According to PCA, variables most correlated with the largest principal components included: DD_18_T, FFP_T, bFFP_P, FFP_P, and TD_P (Figure \@ref(fig:pca)).

```{r pca, include=T, echo=F, fig.cap="PCA", out.width="100%"}

knitr::include_graphics(paste0(wd,'figures/sp_PCA_biplot.png'))

```

  
According to exploration of the difference between trial & provenance, variables included: PAS, TD, MWMT, DD0, and MCMT (Figure \@ref(fig:diff)).

```{r diff, include=TRUE, echo=FALSE, fig.cap="Difference in climate variables between trial and provenance sites"}

knitr::include_graphics(paste0(wd,'figures/H_response_T-P_diff.png'))

```

  
So more generally, the factors driving height may be: *degree days below 18*, *precipitation as snow*, *temperature extremes* (warmest and coldest month temperatures, degree days below 0), *frost free period* and when this begins/ends, and temperature difference between coldest and warmest temperatures (*continentality*).
  
```{r data, include=FALSE, echo=FALSE}

# read in standardised data (with raw height)
#sp.raw <- read.csv(paste0(wd,"Scots_pine/Scots_pine_H.csv")) # raw data PC
sp.raw <- read.csv(paste0(wd,"data-raw/Scots_pine_H.csv")) # raw data Mac
sp.raw$X <- NULL
#str(sp.raw)
sp.raw<-na.omit(sp.raw)
#sp <- read.csv(paste0(wd,"Scots_pine/Scots_pine_H_cent_scal_allvars.csv")) # scaled PC
sp <- read.csv(paste0(wd,"data-raw/Scots_pine_H_cent_scal_allvars.csv")) # scaled Mac
sp$X <- NULL
#str(sp)
colnames(sp)[1]<-"Hscal"
sp$Hraw <- sp.raw$W17Height
sp$Trial <- sp.raw$Trial
sp$Provenance <- sp.raw$Provenance
sp$Block <- sp.raw$Block
colnames(sp)[22]<-'EMT_P'
colnames(sp)[41]<-'EMT_T'
#rm(sp.raw)

```

The data is nested Trial/Block/Provenance. Figure \@ref(fig:boxplot) illustrates that there is variation in height between trials, and also within trials according to provenance. So there is value in fitting a mixed-effects model to explore height, with the random effects structure taking account of the different trials and provenances.

```{r boxplot, include=TRUE, echo=FALSE, fig.cap="Boxplot showing the variation in height at each trial site, split by block and provenance"}
# double check nesting
sp %>% 
  ggplot(aes(Trial:Block:Provenance,Hraw, colour=Trial))+geom_boxplot()+
  theme_minimal()+
  ylab("Height (mm)")+
  theme(axis.text.x = element_blank()) #element_text(size=6,angle = 90, hjust = 1))
```

# Initial models

A number of models combining the potentially important variables highlighted above have been produced.
These were compared via a number of indices (Table \@ref(tab:model-performance)).

## Compare model performance

```{r model-performance, include=TRUE, warning=FALSE, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="A comparison plot of several models"}

# initial models
#pair.mod1 <- lmer(W17Height ~ scale(MWMT_T) + scale(PAS_P) + scale(MWMT_T)*scale(PAS_P) + (1|Trial/Block/Provenance), data=sp.raw)
#pair.mod2 <- lmer(log(W17Height) ~ scale(MWMT_P) + scale(PAS_T) + scale(MWMT_P)*scale(PAS_T) + (1|Trial/Block/Provenance), data=sp.raw)
#pair.mod3 <- lmer(log(W17Height) ~ scale(TD_P) + scale(Eref_T) + scale(TD_P)*scale(Eref_T) + (1|Trial/Block/Provenance), data=sp.raw)
#pca.mod1 <- lmer(log(W17Height) ~ scale(DD_18_T) + scale(FFP_P) + scale(DD_18_T)*scale(FFP_P) + (1|Trial/Block/Provenance), data=sp.raw)
#pca.mod2 <- lmer(log(W17Height) ~ scale(DD_18_T) + scale(TD_P) + scale(DD_18_T)*scale(TD_P) + (1|Trial/Block/Provenance), data=sp.raw)
#pca.mod3 <- lmer(log(W17Height) ~ scale(FFP_T) + scale(TD_P) + scale(FFP_T)*scale(TD_P) + (1|Trial/Block/Provenance), data=sp.raw)
#diff.mod1 <- lmer(log(W17Height) ~ scale(PAS_P) + TD_T + scale(PAS_P)*TD_T + (1|Trial/Block/Provenance), data=sp.raw)
#diff.mod2 <- lmer(log(W17Height) ~ scale(MWMT_P) + scale(MCMT_T) + scale(MWMT_P)*scale(MCMT_T) + (1|Trial/Block/Provenance), data=sp.raw)
#diff.mod3 <- lmer(log(W17Height) ~ scale(DD0_P) + scale(PAS_T) + scale(DD0_P)*scale(PAS_T) + (1|Trial/Block/Provenance), data=sp.raw)
# "best models" from dredge )
#dredge1<-lmer(log(W17Height) ~ scale(DD_18_T) + scale(NFFD_P) + scale(DD_18_T)*NFFD_P + (1|Trial/Block/Provenance),data = sp.raw)
#dredge2<-lmer(log(W17Height) ~ scale(DD_18_T) + scale(NFFD_P) + scale(PAS_T) + scale(DD_18_T)*scale(NFFD_P) + scale(NFFD_P)*scale(PAS_T) + (1|Trial/Block/Provenance),data = sp.raw)
#dredge3<-lmer(log(W17Height) ~ scale(DD_18_T) + scale(NFFD_P) + scale(TD_T) + scale(DD_18_T)*scale(NFFD_P) + scale(NFFD_P)*scale(TD_T)+ (1|Trial/Block/Provenance),data = sp.raw)
# from richard's thesis
#whittet.mod1 <- lmer(log(W17Height) ~ scale(MAP_T) + scale(FFP_P) + scale(MAP_T)*scale(FFP_P) + (1|Trial/Block/Provenance), data = sp.raw)
#whittet.mod2 <- lmer(log(W17Height) ~ scale(MAP_P) + scale(FFP_T) + scale(MAP_P)*scale(FFP_T) + (1|Trial/Block/Provenance), data = sp.raw)
#whittet.mod3 <- lmer(log(W17Height) ~ scale(DD5_T) + scale(MWMT_P) + scale(MCMT_T) + scale(MAP_T) + scale(TD_P) + scale(DD5_T)*scale(MWMT_P) + (1|Trial/Block/Provenance), data = sp.raw)

#compare.mods <- compare_performance(pair.mod1, pair.mod2,pair.mod3,
                                    #pca.mod1,pca.mod2,pca.mod3,
                                    #diff.mod1,diff.mod2,diff.mod3,
                                    #dredge1,dredge2,dredge3,
                                    #whittet.mod1,whittet.mod2,whittet.mod3,
                                    #rank=TRUE)

#plot(compare.mods)

#write.csv(compare.mods, paste0(wd,'/Scots_pine/compare_performance_interactions2.csv'))
compare.mods <- read.csv(paste0(wd,'/Scots_pine/compare_performance_interactions2.csv'))
compare.mods$X<-NULL
knitr::kable(head(compare.mods[,1:9],15), booktabs=TRUE,
             caption = "Comparison of model indices") %>% 
  kableExtra::kable_styling(latex_options = c("hold_position"), font_size = 9)
#compare.perf <- image_read(paste0(wd,'figures/compare_best_interactions.png'))
#print(compare.perf)

```

## Cross-validation

Using the five 'best' models from the comparisons above, cross-validation was carried out.

```{r cross-validation, include=FALSE}
#results<-NULL

#for(i in 1:1000) {
  
  #i<-1
  #rows<-sample(x=1:nrow(sp),size=round(nrow(sp.raw)*0.25,1))
  #training<-sp.raw[-rows,]
  #testing<-sp.raw[rows,]
  
  #dredge3<-lmer(log(W17Height) ~ scale(DD_18_T) + scale(NFFD_P) + scale(TD_T) + scale(DD_18_T)*scale(NFFD_P) + scale(NFFD_P)*scale(TD_T)+ (1|Trial/Block/Provenance),data = training)
  #dredge2<-lmer(log(W17Height) ~ scale(DD_18_T) + scale(NFFD_P) + scale(PAS_T) + scale(DD_18_T)*scale(NFFD_P) + scale(NFFD_P)*scale(PAS_T) + (1|Trial/Block/Provenance),data = training)
  #whittet.mod3 <- lmer(log(W17Height) ~ scale(DD5_T) + scale(MWMT_P) + scale(MCMT_T) + scale(MAP_T) + scale(TD_P) + scale(DD5_T)*scale(MWMT_P) + (1|Trial/Block/Provenance), data = training)
  #pair.mod2 <- lmer(log(W17Height) ~ scale(MWMT_P) + scale(PAS_T) + scale(MWMT_P)*scale(PAS_T) + (1|Trial/Block/Provenance), data=training)
  #diff.mod3 <- lmer(log(W17Height) ~ scale(DD0_P) + scale(PAS_T) + scale(DD0_P)*scale(PAS_T) + (1|Trial/Block/Provenance), data=training)

  #p.d3<-predict(dredge3,testing)-log(testing$W17Height)
  #p.d2<-predict(dredge2,testing)-log(testing$W17Height)
  #p.wh3<-predict(whittet.mod3,testing)-log(testing$W17Height)
  #p.pr2<-predict(pair.mod2,testing)-log(testing$W17Height)
  #p.df3<-predict(diff.mod3,testing)-log(testing$W17Height)
  
  #results<-rbind(results,data.frame(
    #Run=rep(i,5),
    #Model=c('dredge3','dredge2','whittet.mod3','pair.mod2','diff.mod3'),
    #MAE=c(mean(abs(p.d3)),mean(abs(p.d2)),mean(abs(p.wh3)),mean(abs(p.pr2)),mean(abs(p.df3))),
    #R2marg=c(r2(dredge3)$R2_marginal, r2(dredge2)$R2_marginal,r2(whittet.mod3)$R2_marginal,
             #r2(pair.mod2)$R2_marginal,r2(diff.mod3)$R2_marginal)))
  
#}

#write.csv(results, paste0(wd,'Scots_pine/cross-validation_results_interactions2.csv'))

```


```{r cv-results, include=T, echo=FALSE, warning=FALSE}
results<-read.csv(paste0(wd,'Scots_pine/cross-validation_results_interactions2.csv'))
#summary(results)
#hist(results$MAE,breaks=50)
#hist(results$R2marg,breaks=50)

results %>% 
  ggplot(aes(Model,MAE, colour=Model))+geom_boxplot()+
  theme_minimal()+
  ylab("MAE")+
  theme(axis.text.x = element_blank())

results %>% 
  ggplot(aes(Model,R2marg, colour=Model))+geom_boxplot()+
  theme_minimal()+
  ylab("R2marg")+
  theme(axis.text.x = element_blank())

#resAVE<-aggregate(MAE~Model,results,FUN=mean)
#resAVE<-resAVE[order(resAVE[,2],decreasing=F),]

```

The results of the cross validation indicate that "dredge2" and "dredge3" have the highest R2 marginal.
Both also showed the lowest Mean Absolute Error (MAE).
These two models were therefore taken forwards to be tested within the ΔTraitSDM framework.
The two models took the forms:

dredge2 = Height ~ DD_18_T + NFFD_P + PAS_T + DD_18_T x NFFD_P + NFFD_P x PAS_T + (1|Trial/Block/Provenance)

dredge3 = Height ~ DD_18_T + NFFD_P + TD_T + DD_18_T x NFFD_P + NFFD_P x TD_T+ (1|Trial/Block/Provenance)

Their summaries are shown below:

```{r dredge2, include=TRUE, echo=FALSE}

dredge2<-lmer(log(W17Height) ~ scale(DD_18_T) + scale(NFFD_P) + scale(PAS_T) + scale(DD_18_T)*scale(NFFD_P) + scale(NFFD_P)*scale(PAS_T) + (1|Trial/Block/Provenance),data = sp.raw)

stargazer(dredge2, type = "text",
          digits = 3,
          star.cutoffs = c(0.05, 0.01, 0.001),
          digit.separator = "")

```

The summary of dredge 2 illustrates that...

```{r dredge3, include=TRUE, echo=FALSE}

dredge3<-lmer(log(W17Height) ~ scale(DD_18_T) + scale(NFFD_P) + scale(TD_T) + scale(DD_18_T)*scale(NFFD_P) + scale(NFFD_P)*scale(TD_T)+ (1|Trial/Block/Provenance),data = sp.raw)

stargazer(dredge3, type = "text",
          digits = 3,
          star.cutoffs = c(0.05, 0.01, 0.001),
          digit.separator = "")

```

The summary of dredge3 illustrates that...
As degree days below 18 decrease, height decreases (not significant).
As the number of frost-free days increase, height increases slightly (significant).
As continentality increases (larger annual temperature range), height increases (signficant).


```{r visualise-fixed, included=TRUE, echo=FALSE, fig.cap="Visualisation of fixed effects for dredge3" }

# Extract out the parameter estimates and confidence intervals and manipulate the data
dataPlot <- data.frame(cbind( fixef(dredge3), confint(dredge3)[ 5:10, ]))
rownames(dataPlot)[1] <- "Intercept"
colnames(dataPlot) <- c("est", "L95", "U95")
dataPlot$parameter <- rownames(dataPlot)

# Print the new dataframe
print(dataPlot)

# Plot the results using ggplot2
ggplot(dataPlot, aes(x = parameter, y = est,
                     ymin = L95, ymax = U95)) +
    geom_hline( yintercept = 0, color = 'red' ) +
    geom_linerange() + geom_point() + coord_flip() + theme_minimal()

```

```{r}
install.packages("devtools")
library(devtools)
devtools::install_github("neuropsychology/psycho.R")
library(psycho)

devtools::install_github("easystats/easystats")

dredge3<-lmer(log(W17Height) ~ scale(DD_18_T) + scale(NFFD_P) + scale(TD_T) + scale(DD_18_T)*scale(NFFD_P) + scale(NFFD_P)*scale(TD_T)+ (1|Trial/Block/Provenance),data = sp.raw)

results <- psycho::analyze(dredge3, CI = 95)

summary(results) %>% 
  mutate(p = psycho::format_p(p))
```


<!--The performance of each model is illustrated by Figures \@ref(fig:dredge2-check) and \@ref(fig:dredge3-check).

```{r dredge2-check, include=TRUE,echo=FALSE,fig.cap="dredge2 model performance"}

check_model(dredge2)

```

```{r dredge3-check, include=TRUE,echo=FALSE,fig.cap="dredge3 model performance"}

check_model(dredge3)

```

The model checks above show that...-->

# ΔTraitSDM

Several approaches were taken when applying the models within ΔTraitSDM.

Firstly, climate surfaces for the 'climate normal' period (an average taken from 1960-1990) were used to estimate distribution.

Secondly, separate climate surfaces were produced for the year when the seed was collected for the provenance trial (2007) and the year the seedlings were planted at the trial site (2012).

Finally, a climate surface representing possible future climate change was used to estimate future distribution.

## Predicted distribution for current climate

```{r climate-surfaces, include=FALSE, echo=FALSE}

#library(foreign)
#dem <- raster(paste0(wd,'/climate_surfaces/UKdem1k.tif'))
# convert to dataframe x,y,elev
#demDF <- as.data.frame(dem,xy=TRUE)
#head(demDF)
#colnames(demDF) <- c('x','y','elev')
# export for Arc to get coordinates
#write.csv(demDF, paste0(wd,"climate_surfaces/UKdem1k_df.csv"), row.names = FALSE, quote = FALSE)
# read back in reprojected data (WGS84) with lat long (data management::features::get xy coordinates)
#coords <- read.dbf(paste0(wd,"climate_surfaces/dem1k_reproj.dbf"))
#head(coords)
#summary(coords)
#coords$elev<-as.numeric(as.character(coords$elev))
#summary(coords)
#coords<-na.omit(coords)
#coords<-filter(coords, elev!=1080)
# correct format
#coords <- coords[,c(1,2,5,4,3)]
#colnames(coords) <- c("id1","id2","lat","long","elev")
#head(coords)
#histogram(coords$elev)
#check
#ggplot(coords)+
  #geom_point(aes(long,lat,col=elev))

# export for climateEU
#write.csv(coords, paste0(wd,"climate_surfaces/for-climateEU.csv"))

# read in climate data
#climate <- read.csv(paste0(wd,"climate_surfaces/for-climateEU_Normal_1961_1990Y.csv"))
#head(climate)
#colnames(climate)<-c('x','y','lat','long','elev','MAT','MWMT','MCMT','TD','MAP','MSP','AHM','SHM','DD0','DD5','DD_18','DD18','NFFD','bFFP','eFFP','FFP','PAS','EMT','Eref','CMD')
#climate[climate=="-9999"]<-NA
#climate <- na.omit(climate)
#summary(climate)
#ggplot(climate)+geom_point(aes(x,y))
#coordinates(climate) <- ~ x + y
#gridded(climate) <- TRUE
#MAP <- raster(climate,layer='MAP')
#FFP <- raster(climate,layer='FFP')
#PAS <- raster(climate,layer="PAS")
#MWMT <- raster(climate,layer='MWMT')
# check climate data looks ok
#stack.1 <- stack(MAP,FFP,PAS,MWMT)
#plot(stack.1,main="Check the climate variable are plotting correctly (30 yr average)")

```

Figures \@ref(fig:DTSDM1) and \@ref(fig:DTSDM1a) show predicted height distribution for the current climate using the 30yr average climate 'normal' for two models.

```{r DTSDM1, include=TRUE, echo=FALSE, warning=FALSE, fig.cap="Height predicted using 30yr average normal climate (dredge2)"}

wd <- "~/R/DeltaTraitSDM/"

# sp data
sp.raw <- read.csv(paste0(wd,"Scots_pine/Scots_pine_H.csv")) # raw data
sp.raw$X <- NULL
#str(sp.raw)
sp.raw<-na.omit(sp.raw)

# check data for input to climateEU
#cEUinput <- read.csv(paste0(wd,"climate_surfaces/for-climateEU.csv"))
#head(cEUinput)

# use 30 yr average rasters first
climate <- read.csv(paste0(wd,"climate_surfaces/for-climateEU_Normal_1961_1990Y.csv"))
#head(climate)
colnames(climate)<-c('x','y','lat','long','elev','MAT','MWMT','MCMT','TD','MAP','MSP','AHM','SHM','DD0','DD5','DD_18','DD18','NFFD','bFFP','eFFP','FFP','PAS','EMT','Eref','CMD')
climate[climate=="-9999"]<-NA
climate <- na.omit(climate)
#summary(climate)
#ggplot(climate)+geom_point(aes(x,y))
coordinates(climate) <- ~ x + y
gridded(climate) <- TRUE
#summary(climate)
DD_18_T <- raster(climate,layer='DD_18')
NFFD_P <- raster(climate,layer="NFFD")
PAS_T <- raster(climate,layer="PAS")
TD_T <- raster(climate,layer="TD")

# raster stack of climate variables
ST_H <- DD_18_T
#mean(sp$Hraw) #  stand age
values(ST_H) <- 126 # assign mean height to raster of same extent
#plot(ST_H)

rsmax1 <- stack(ST_H, DD_18_T, NFFD_P, PAS_T) 
names(rsmax1)= c("W17Height","DD_18_T","NFFD_P","PAS_T")
#names(rsmax1)
#plot(rsmax1, main="Raster stack for model input")

#crs(predH)<- "+init=epsg:27700" # british national grid
UK <- shapefile(paste0(wd,"Scots_pine/european_region_region.shp"))
#unique(UK$NAME)
scot <- UK[which(UK$NAME=="Scotland Euro Region"),]
#plot(scot)

dredge2<-lmer(log(W17Height) ~ scale(DD_18_T) + scale(NFFD_P) + scale(PAS_T) + scale(DD_18_T)*scale(NFFD_P) + scale(NFFD_P)*scale(PAS_T) + (1|Trial/Block/Provenance),data = sp.raw)
predH1 <- predict(rsmax1, dredge2, re.form=NA, type='response') #whittet.mod2 #dredge1
predH1<- log(predH1)
predH1_crop <- crop(predH1, scot)
#plot(predH1_crop, main="Tree height predicted (30yr avg climate) (dredge2)")

crs(predH1_crop)<- "+init=epsg:27700" # british national grid
# palette
vir <- viridis(5)
#mag <- magma(5)

tm_shape(predH1_crop) +
  tm_raster(title="Predicted height (exp)",
            palette=vir,
            style="quantile") +
  tm_legend(outside = TRUE,
            legend.title.size=0.8,
            legend.text.size=0.6)+
  tm_shape(scot)+
  tm_borders("lightgrey",lwd=1)+
  tm_layout(main.title="Tree height predicted under current (30 year average) climate (Model | dredge2)", 
            main.title.size = 0.9,
            main.title.fontface = "bold")

```

```{r DTSDM1a, include=TRUE, echo=FALSE, warning=FALSE, fig.cap="Height predicted using 30yr average normal climate (dredge3"}

dredge3<-lmer(log(W17Height) ~ scale(DD_18_T) + scale(NFFD_P) + scale(TD_T) + scale(DD_18_T)*scale(NFFD_P) + scale(NFFD_P)*scale(TD_T)+ (1|Trial/Block/Provenance),data = sp.raw)
rsmax2 <- stack(ST_H, DD_18_T, NFFD_P, TD_T) 
names(rsmax2)= c("W17Height","DD_18_T","NFFD_P", "TD_T")
#names(rsmax2)
#plot(rsmax2,main="Raster stack for model input")
predH2 <- predict(rsmax2, dredge3, re.form=NA, type='response') #whittet.mod2 #dredge1
predH2<- exp(predH2)
predH2_crop <- crop(predH2, scot)
#plot(predH2_crop, main="Tree height predicted (30yr avg climate) (dredge3)")

crs(predH2_crop)<- "+init=epsg:27700" # british national grid

tm_shape(predH2_crop) +
  tm_raster(title="Predicted height (exp)",
            palette=vir,
            style="quantile") +
  tm_legend(outside = TRUE,
            legend.title.size=0.8,
            legend.text.size=0.6)+
  tm_shape(scot)+
  tm_borders("lightgrey",lwd=1)+
  tm_layout(main.title="Tree height predicted under current (30 year average) climate (Model | dredge3)", 
            main.title.size = 0.9,
            main.title.fontface = "bold")

```

Text here considering outputs from 30yr average climate data above.

```{r DTSDM2, include=T, echo=F, warning=FALSE, fig.cap="Height predicted using climate data from seed collection and planting years"}

#########################################################################
# process rasters for planting year (T) and when seeds were harvested (P)
# seeds taken (P) | 2007
# planted (T) | 2012
#########################################################################

# use Climate EU to generate raster surfaces for provenance and trial sites separately
clim07 <- read.csv(paste0(wd,"climate_surfaces/forclimateEU_Year_2007MSY.csv"))
#head(clim07)
clim07 <- clim07[,c(1:5,70:89)]
colnames(clim07)<-c('x','y','lat','long','elev','MAT_P','MWMT_P','MCMT_P','TD_P','MAP_P','MSP_P','AHM_P','SHM_P',
                    'DD0_P','DD5_P','DD_18_P','DD18_P','NFFD_P','bFFP_P','eFFP_P','FFP_P','PAS_P','EMT_P','Eref_P','CMD_P')
clim07[clim07=="-9999"]<-NA
clim07 <- na.omit(clim07)
#summary(clim07)

clim12 <- read.csv(paste0(wd,"climate_surfaces/forclimateEU_Year_2012MSY.csv"))
#head(clim12)
clim12 <- clim12[,c(1:5,70:89)]
colnames(clim12)<-c('x','y','lat','long','elev','MAT_T','MWMT_T','MCMT_T','TD_T','MAP_T','MSP_T','AHM_T','SHM_T',
                    'DD0_T','DD5_T','DD_18_T','DD18_T','NFFD_T','bFFP_T','eFFP_T','FFP_T','PAS_T','EMT_T','Eref_T','CMD_T')
clim12[clim12=="-9999"]<-NA
clim12 <- na.omit(clim12)
#summary(clim12)

coordinates(clim07) <- ~ x + y
gridded(clim07) <- TRUE
NFFD_P <- raster(clim07,layer='NFFD_P')
#plot(NFFD_P,main="Number of frost-free days at the provenance")
coordinates(clim12) <- ~ x + y
gridded(clim12) <- TRUE
DD_18_T <- raster(clim12,layer='DD_18_T')
PAS_T <- raster(clim12,layer="PAS_T")
TD_T<-raster(clim12,layer="TD_T")

# once rasters are processed, scale them, or ensure that model equation scales them
# raster stack of climate variables

dredge3<-lmer(log(W17Height) ~ scale(DD_18_T) + scale(NFFD_P) + scale(TD_T) + scale(DD_18_T)*scale(NFFD_P) + scale(NFFD_P)*scale(TD_T)+ (1|Trial/Block/Provenance),data = sp.raw)
rsmax3 <- stack(ST_H, DD_18_T, NFFD_P, TD_T) 
names(rsmax3)= c("W17Height","DD_18_T","NFFD_P", "TD_T")
#names(rsmax3)
#plot(rsmax3,main="Raster stack for model input")
predH3 <- predict(rsmax3, dredge3, re.form=NA, type='response') #whittet.mod2 #dredge1
predH3<- exp(predH3)
predH3_crop <- crop(predH3, scot)
#plot(predH3_crop, main="Tree height predicted using seed collection and planting year climate (dredge3)")

crs(predH3_crop)<- "+init=epsg:27700" # british national grid

tm_shape(predH3_crop) +
  tm_raster(title="Predicted height (exp)",
            palette=vir,
            style="quantile") +
  tm_legend(outside = TRUE,
            legend.title.size=0.8,
            legend.text.size=0.6)+
  tm_shape(scot)+
  tm_borders("lightgrey",lwd=1)+
  tm_layout(main.title="Tree height predicted using seed collection and planting year climate (Model | dredge3)", 
            main.title.size = 0.9,
            main.title.fontface = "bold")

```

Text here considering \@ref(fig:DTSDM2)... using separate climate rasters for seed collection year and planting year...

These results were then masked using the current distribution of Scots pine taken from the Native Woodland Survey Scotland...

```{r current-dist, include=TRUE,echo=FALSE,warning=FALSE,fig.cap="Predicted height masked by current distribution of native Scots pine"}

# current distribution
nwss <- shapefile(paste0(wd,"Scots_pine/FCPRODUCT_S_NWSS.shp")) 
#summary(nwss)
nwss<-st_as_sf(nwss)
#unique(nwss$DOM_HABITA)
nativePine<-nwss[which(nwss$DOM_HABITA=="Native pinewood"),]
#crs(predH3_crop)
#crs(nativePine)
crs(predH3_crop)<-crs(nativePine)
predH_mask<- mask(predH3_crop, nativePine) 
#plot(predH_mask, main="Tree height prediction within Scots pine range for current climatic conditions")

tm_shape(predH_mask) +
  tm_raster(title="Predicted height (exp)",
            palette=vir,
            style="quantile") +
  tm_legend(outside = TRUE,
            legend.title.size=0.8,
            legend.text.size=0.6)+
  tm_shape(scot)+
  tm_borders("lightgrey",lwd=1)+
  tm_layout(main.title="Tree height predicted under current climate, masked by current distribution", 
            main.title.size = 0.9,
            main.title.fontface = "bold")

```


<!--```{r future-dist, include=TRUE,echo=FALSE,fig.cap="Future suitability for native Scots pine"}

# future potential distribution
#esc <- shapefile(paste0(wd,"Scots_pine/sp_esc_baseline.shp"))
#plot(esc)
#crs(esc)
#esc_crop <- crop(esc,scot)
#predH_mask2 <- mask(predH3_crop,esc)

```-->

## Predicted distribution under future climate

Figure \@ref(fig:DTSDM3) illustrates predicted height distribution for 2050 according to predicted climate for RCP 8.5.

```{r DTSDM3, include=TRUE, echo=FALSE, fig.cap="Tree height predicted for future climate", warning=FALSE}

clim2050 <- read.csv(paste0(wd,"climate_surfaces/for-climateEU_HadGEM2-ES_rcp85_2050sY.csv"))
#head(clim2050)
colnames(clim2050)<-c('x','y','lat','long','elev','MAT_T','MWMT_T','MCMT_T','TD_T','MAP_T','MSP_T','AHM_T','SHM_T','DD0_T','DD5_T','DD_18_T','DD18_T','NFFD_T','bFFP_T','eFFP_T','FFP_T','PAS_T','EMT_T','Eref_T','CMD_T')
clim2050[clim2050=="-9999"]<-NA
clim2050 <- na.omit(clim2050)
#summary(clim12)

coordinates(clim2050) <- ~ x + y
gridded(clim2050) <- TRUE
DD_18_T <- raster(clim2050,layer='DD_18_T')
NFFD_P <- raster(clim2050, layer="NFFD_T")
TD_T <- raster(clim2050, layer="TD_T")

ST_H <- DD_18_T
#mean(sp$Hraw) #  stand age
values(ST_H) <- 126 # assign mean height to raster of same extent
#plot(ST_H)

dredge3<-lmer(log(W17Height) ~ scale(DD_18_T) + scale(NFFD_P) + scale(TD_T) + scale(DD_18_T)*scale(NFFD_P) + scale(NFFD_P)*scale(TD_T)+ (1|Trial/Block/Provenance),data = sp.raw)
rsmax4 <- stack(ST_H, DD_18_T, NFFD_P, TD_T) 
names(rsmax4)= c("W17Height","DD_18_T","NFFD_P", "TD_T")
#names(rsmax3)
#plot(rsmax3,main="Raster stack for model input")
predH4 <- predict(rsmax4, dredge3, re.form=NA, type='response') #whittet.mod2 #dredge1
predH4<- exp(predH4)
predH4_crop <- crop(predH4, scot)
#plot(predH4_crop, main="Tree height predicted for 2050 (RCP8.5) (dredge3)")

#crs(predH4_crop)
crs(predH4_crop)<- "+init=epsg:27700" # british national grid

# palette
vir <- viridis(5)
#mag <- magma(5)

#classIntervals(values(predH4_crop[["layer"]]), n=5, style = "quantile")

tm_shape(predH4_crop) +
  tm_raster(title="Predicted height (exp)",
            palette=vir,
            style="quantile") +
  tm_legend(outside = TRUE,
            legend.title.size=0.8,
            legend.text.size=0.6)+
  tm_shape(scot)+
  tm_borders("lightgrey",lwd=1)+
  tm_layout(main.title="Tree height predicted for 2050, RCP8.5 (Model | dredge3)", 
            main.title.size = 0.9,
            main.title.fontface = "bold")


```

# Conclusions and next steps


